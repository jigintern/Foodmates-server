package models

import (
	"errors"
	"fmt"
	_ "github.com/go-sql-driver/mysql"
	"github.com/jinzhu/gorm"
	"os"
)

var db *gorm.DB

func InitDB() {
	USER := os.Getenv("MYSQL_USER")
	PASS := os.Getenv("MYSQL_PASSWORD")
	PROTOCOL := "tcp(mysql_host:3306)"
	DBNAME := os.Getenv("MYSQL_DATABASE")

	var err error
	CONNECT := USER + ":" + PASS + "@" + PROTOCOL + "/" + DBNAME + "?charset=utf8&parseTime=True&loc=Local"

	fmt.Println("* Opening Mysql database...")
	db, err = gorm.Open("mysql", CONNECT)

	if err != nil {
		panic(err.Error())
	}

	fmt.Println("* Mysql database opened!!")
	db.LogMode(true)
	InitTables(db)
}

func TruncateTables(db2 *gorm.DB) {
	rows, err := db2.Raw("show tables").Rows()
	if err != nil {
		panic(err.Error())
	}
	defer rows.Close()
	for rows.Next() {
		var table string
		if err := rows.Scan(&table); err != nil {
			panic(err.Error())
		}
		db.Exec("TRUNCATE TABLE " + table)
	}
}

func InitTables(db2 *gorm.DB) {
	tx := db2.Begin()
	TruncateTables(tx)
	tx.Exec("INSERT INTO `Dishes` (`id`, `created_at`, `updated_at`, `deleted_at`, `dish_name`, `store_name`)VALUES(1, '2019-09-04 04:35:05', '2019-09-04 04:35:41', NULL, 'åŒ—æ¥µãƒ©ãƒ¼ãƒ¡ãƒ³', 'è’™å¤ã‚¿ãƒ³ãƒ¡ãƒ³ä¸­æœ¬'),(2, '2019-09-04 04:59:42', '2019-09-04 05:02:40', NULL, 'é‡èœãƒ©ãƒ¼ãƒ¡ãƒ³(å‘³å™Œ)', '8ç•ªãƒ©ãƒ¼ãƒ¡ãƒ³'),(3, '2019-09-04 04:59:42', '2019-09-04 05:02:45', NULL, 'é‡èœãƒ©ãƒ¼ãƒ¡ãƒ³(å¡©)', '8ç•ªãƒ©ãƒ¼ãƒ¡ãƒ³'),(4, '2019-09-04 04:59:42', '2019-09-04 05:03:19', NULL, 'é‡èœãƒ©ãƒ¼ãƒ¡ãƒ³(é†¤æ²¹)', '8ç•ªãƒ©ãƒ¼ãƒ¡ãƒ³'),(5, '2019-09-04 04:59:42', '2019-09-04 05:03:21', NULL, 'é‡èœãƒ©ãƒ¼ãƒ¡ãƒ³(è±šéª¨)', '8ç•ªãƒ©ãƒ¼ãƒ¡ãƒ³'),(6, '2019-09-04 04:59:42', '2019-09-04 05:08:58', NULL, 'ãƒ©ãƒ¼ãƒ¡ãƒ³(ä¸­)', 'ãƒ©ãƒ¼ãƒ¡ãƒ³æ± ç”°å±‹'),(7, '2019-09-04 04:59:42', '2019-09-04 06:02:09', NULL, 'ãƒ©ãƒ¼ãƒ¡ãƒ³(å¤§)', 'ãƒ©ãƒ¼ãƒ¡ãƒ³æ± ç”°å±‹'),(8, '2019-09-04 04:59:42', '2019-09-04 06:02:19', NULL, 'jigã‚«ãƒ¬ãƒ¼', 'jig.jp'),(9, '2019-09-04 06:20:14', '2019-09-04 06:24:01', NULL, 'ã‚µãƒã‚¨ãƒ‰ãƒƒã‚°', 'ãƒŸãƒ¼ãƒˆ&ãƒ‡ãƒªã‚«ã•ã•ã'),(10, '2019-09-04 06:25:09', '2019-09-04 06:25:14', NULL, 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãŠã‚ã—ãƒãƒ³é…¢ç‰›ã‚ã— ä¸¦ç››', 'æ¾å±‹'),(11, '2019-09-04 06:37:21', '2019-09-04 06:37:24', NULL, 'ã‚¿ã‚³ãƒ©ã‚¤ã‚¹', 'JCH'),(12, '2019-09-04 06:45:05', '2019-09-04 06:45:24', NULL, 'ç¦äº•åç‰©å®šé£Ÿ', 'ç¦ç¦èŒ¶å±‹'),(13, '2019-09-04 06:53:15', '2019-09-04 06:53:18', NULL, 'SK', NULL),(14, '2019-09-04 06:57:34', '2019-09-04 06:57:47', NULL, 'ãƒã‚­ãƒ³ã‚«ãƒ¬ãƒ¼', 'ã‚«ãƒ¬ãƒ¼ã®ç‹æ§˜'),(15, '2019-09-04 06:58:52', '2019-09-04 06:59:11', NULL, 'ã‚µãƒ¼ãƒ¢ãƒ³3ç¨®', 'æµ·é®®ã‚¢ãƒˆãƒ '),(16, '2019-09-04 07:00:56', '2019-09-04 07:01:06', NULL, 'ãƒãƒ¼ã‚ºãƒŠãƒ³ã‚»ãƒƒãƒˆ', 'ã‚¬ãƒ³ã‚¸ãƒ¼'),(17, '2019-09-04 07:02:32', '2019-09-04 07:02:43', NULL, 'é‡œé£¯', 'çª¯è”µ'),(18, '2019-09-04 07:05:01', '2019-09-04 07:05:09', NULL, 'ãƒãƒ¼ã‚¯ã‚«ãƒ¬ãƒ¼', 'LAND');")
	tx.Exec("INSERT INTO `Follows` (`id`, `user_id`, `follow_id`, `created_at`, `updated_at`)VALUES(1, 1, 1, '2019-08-23 08:47:14', '2019-08-23 08:47:14'),(2, 1, 3, '2019-08-23 08:47:20', '2019-08-23 08:47:20'),(4, 1, 2, '2019-08-26 01:41:21', '2019-08-26 01:41:21'),(11, 1, 3, '2019-08-26 06:45:38', '2019-08-26 06:45:38'),(12, 1, 3, '2019-08-26 07:04:41', '2019-08-26 07:04:41'),(13, 1, 3, '2019-08-26 07:06:27', '2019-08-26 07:06:27'),(14, 1, 3, '2019-08-26 07:29:35', '2019-08-26 07:29:35'),(15, 1, 3, '2019-08-26 07:30:02', '2019-08-26 07:30:02');")
	tx.Exec("INSERT INTO `Posts` (`id`, `user_id`, `created_at`, `updated_at`, `dish_id`, `comment`, `image_address`)VALUES(1, 2, '2019-09-04 04:34:22', '2019-09-04 06:54:29', 1, 'è¾›ã•ãŒã¡ã‚‡ã†ã©ã‚ˆã‹ã£ãŸ', '/uploads/pictures/20190904044406_ramen_top_tantanmen.png'),(2, 2, '2019-09-04 04:34:22', '2019-09-04 06:54:30', 2, 'æ„å¤–ã¨é‡ãŒå¤šã‹ã£ãŸ', '/uploads/pictures/20190904050718_IMG_7274.JPG'),(3, 2, '2019-09-04 04:34:22', '2019-09-04 06:54:32', 6, 'äºŒéƒç³»ãƒ©ãƒ¼ãƒ¡ãƒ³åº—ã«ã—ã¦ã¯ãã“ã¾ã§å‘³ã¯æ¿ƒããªã„ã®ã§ã€äºŒéƒç³»å…¥é–€ã«ã‚ªã‚¹ã‚¹ãƒ¡ã€‚ãŸã é‡ã¯éå¸¸ã«å¤šã„ã®ã§ã€æ°—ã‚’ã¤ã‘ã‚‹ã¹ã—ã€‚', '/uploads/pictures/20190904051117_IMG_6416.jpg'),(4, 3, '2019-09-04 04:34:22', '2019-09-04 06:54:36', 6, 'ã“ã‚Œã¯å¤ªã‚Šãã†ã€‚', NULL),(5, 5, '2019-09-04 04:34:22', '2019-09-04 06:25:47', 8, 'jig.jpé™å®šjigã‚«ãƒ¬ãƒ¼ ã¨ã«ã‹ãã‚¹ãƒ”ãƒ¼ãƒ‰ãŒæ—©ã„', '/uploads/pictures/20190904060142_IMG_7219.JPG'),(6, 2, '2019-09-04 04:34:22', '2019-09-04 06:25:49', 9, 'ãã‚Œãªã‚Šã«ã‚½ãƒ¼ã‚¹ã‚«ãƒ„ä¸¼ã®å‘³ãŒã—ãŸ', '/uploads/pictures/20190904062326_IMG_6269.jpg'),(7, 3, '2019-09-04 04:34:22', '2019-09-04 06:25:50', 9, 'åç§°ãã®ã¾ã¾ã€æ­©ãã‚½ãƒ¼ã‚¹ã‚«ãƒ„ä¸¼ï¼', '/uploads/pictures/20190904062326_IMG_6269.jpg'),(8, 4, '2019-09-04 04:34:22', '2019-09-04 06:25:52', 9, 'ã„ã„å‘³ã—ã¦ã‚“ã­ã‡ï¼', '/uploads/pictures/20190904062326_IMG_6269.jpg'),(9, 5, '2019-09-04 04:34:22', '2019-09-04 06:25:54', 9, 'ã¨ã¦ã‚‚é£Ÿã¹ã‚„ã™ã„ã§ã™ã­', '/uploads/pictures/20190904062326_IMG_6269.jpg'),(10, 2, '2019-09-04 04:34:22', '2019-09-04 06:54:42', 10, 'ã•ã£ã±ã‚Šã—ã¦ãŸ', NULL),(11, 4, '2019-09-04 06:37:38', '2019-09-04 06:37:50', 11, 'é‡èœã‚‚ã¤ã„ã¦ã¦ç¾å‘³ã—ã‹ã£ãŸã§ã™ã€‚èª¿ç†ã‚‚ç°¡å˜ã§ã—ãŸï¼', NULL),(12, 2, '2019-09-04 06:45:33', '2019-09-04 06:49:21', 12, 'å€¤æ®µã®å‰²ã«é‡ã‚‚å¤šãã€ç¦äº•ã‚’å ªèƒ½ã§ãã‚‹ä¸€å“ã§ã—ãŸï¼', '/uploads/pictures/20190904064743_IMG_7394.jpg'),(13, 3, '2019-09-04 06:52:51', '2019-09-04 06:53:54', 13, 'æ€ã£ãŸã‚ˆã‚Šè–„ã‚ã®å‘³ä»˜ã‘ã§ã€ã¨ã¦ã‚‚ã•ã£ã±ã‚Šã—ã¦ã¾ã—ãŸï¼ã‚‚ã†ä¸€æ¯é£Ÿã¹ã‚‰ã‚Œãã†ã§ã™^^', '/uploads/pictures/20190904065348_sk.jpg'),(14, 1, '2019-09-04 06:57:07', '2019-09-04 06:58:05', 14, 'ã¡ã‚‡ã†ã©ã„ã„è¾›ã•ã§ã¨ã¦ã‚‚ç¾å‘³ã—ã‹ã£ãŸã§ã™ï¼ãƒŠãƒ³ã‚‚æœ€é«˜ã§ã—ãŸ', '/uploads/pictures/20190904065658_curry.jpg'),(15, 1, '2019-09-04 06:58:34', '2019-09-04 07:01:24', 15, 'ã‚µãƒ¼ãƒ¢ãƒ³å¤§å¥½ãã£å­ãªã®ã§ã€æœ€é«˜ã§ã—ãŸ ğŸ‘', '/uploads/pictures/20190904065937_salmon.jpg'),(16, 1, '2019-09-04 07:00:28', '2019-09-04 07:01:12', 16, 'ãƒãƒ¼ã‚ºãƒŠãƒ³ã‚ã¡ã‚ƒãã¡ã‚ƒç¾å‘³ã—ã‹ã£ãŸï¼ï¼', '/uploads/pictures/20190904070020_curry2.jpg'),(17, 1, '2019-09-04 07:02:04', '2019-09-04 07:04:45', 17, 'é‡œé£¯ã‚’ã‚ã‚“ã¾ã‚Šé£Ÿã¹ãŸã“ã¨ãŒãªã‹ã£ãŸã®ã§ã™ãŒã€ã¡ã‚‡ã†ã©ã„ã„é‡ã§æœ€é«˜ã§ã—ãŸ', '/uploads/pictures/20190904070156_meshi.jpg'),(18, 1, '2019-09-04 07:03:18', '2019-09-04 07:05:13', 18, 'ã‚¹ãƒ‘ã‚¤ã‚¹ãŒã¨ã¦ã‚‚åŠ¹ã„ãŸå°‘ã—è¾›ã‚ã®ã‚«ãƒ¬ãƒ¼ã§ã—ãŸã€‚é–‹åº—30åˆ†å‰ã‹ã‚‰å¤§è¡Œåˆ—ã§ã—ãŸãŒã€ä¸¦ã‚“ã ç”²æ–ã‚ã‚Šã¾ã—ãŸ', '/uploads/pictures/20190904070308_pork.jpg');")
	tx.Exec("INSERT INTO `Users` (`id`, `name`, `created_at`, `updated_at`, `biography`, `birth`, `country`, `prefecture`, `icon_address`)VALUES(1, 'ã‚„ã¾ã ', '2019-09-04 04:44:38', '2019-09-04 06:31:22', 'jig.jp ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', '1980-02-03', 'Japan', 'Fukui', NULL),(2, 'ã§ã¿', '2019-09-04 04:44:38', '2019-09-04 05:53:08', 'ã¾ã„ã¥ã‚‹ã“ãƒ¼ã›ã‚“', '1980-02-03', 'Japan', 'Kyoto', NULL),(3, 'watano', '2019-09-04 04:44:38', '2019-09-04 05:50:45', 'ã„ã°ã‚‰ãã“ãƒ¼ã›ã‚“', '1980-02-03', 'Japan', 'Ibaraki', NULL),(4, 'ã¯ãŸã¯ãŸ', '2019-09-04 04:44:38', '2019-09-04 05:53:20', 'ã¤ã‚„ã¾ã“ãƒ¼ã›ã‚“', '1980-02-03', 'Japan', 'Okayama', NULL),(5, 'ç®’ã‚³ã‚¦ãƒ¢ãƒª', '2019-09-04 04:44:38', '2019-09-04 05:54:06', 'ã‹ãŒã‚ã“ãƒ¼ã›ã‚“ãŸã‹ã¾ã¤ãã‚ƒã‚“ã±ã™', '1980-02-03', 'Japan', 'Kagawa', NULL);")
	if tx.Error != nil {
		fmt.Println("\x1b[31mstarting transition failed.\x1b[0m")
		tx.Rollback()
		return
	}
	tx.Commit()
}

func GetDB() (*gorm.DB, error) {
	if db == nil {
		return nil, errors.New("database reference is null")
	}
	return db, nil
}

func Finalize() error {
	err := db.Close()
	return err
}
